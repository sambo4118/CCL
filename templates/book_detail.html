{% extends "base.html" %}
{% block body %}
<div class="detail-header-wrapper" style="display: flex; min-height: 220px; border-radius: 1rem; overflow: hidden; align-items: stretch; flex-wrap: wrap;">
    <div class="detail-header-primary has-background-primary is-flex" style="color: white; min-width: 250px; flex: 5; display: flex; flex-direction: row; justify-content: flex-start; align-items: stretch; position: relative;">
        <button id="edit-book-btn" class="button is-ghost has-text-white" style="position: absolute; top: 0.5rem; left: 0.5rem; padding: 0.5rem; z-index: 10;" title="Edit book information">
            <span class="icon">
                <i class="fas fa-cog"></i>
            </span>
        </button>
        
        <!-- Book Cover -->
        <div style="width: 140px; min-width: 100px; max-width: 140px; display: flex; align-items: center; justify-content: center; padding: 1rem; padding-left: 1.5rem;">
            <img src="/api/book/{{ book.localnumber }}/cover" 
                 alt="{{ book.title }}" 
                 style="width: 100%; height: auto; max-height: 180px; object-fit: contain; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.3);"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'color: rgba(255,255,255,0.3); text-align: center;\'><i class=\'fas fa-book fa-3x\'></i></div>';">
        </div>
        
        <!-- Book Info -->
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; padding-left: 1rem; padding-right: 1rem;">
            <div class="block">
                <h1 class="title is-2 has-text-weight-semibold">{{ book.title }}</h1>
            </div>
            {% if book.subtitle %}
            <div class="block">
                <h3 class="subtitle has-text-black has-text-weight-semibold is-3">{{ book.subtitle }}</h3>
            </div>
            {% endif %}
            <div class="block">
            <p class="is-size-5 has-text-black" style="margin-top:0.5rem;">by: {{ book.author if book.author else 'Unknown' }}</p>
            </div>
        </div>
    </div>
    <div class="detail-header-info section p-0" style="flex: 7;">
        <div style="width:100%; height:100%; background: linear-gradient(270deg, #14161a 0%, #6a9a75 100%); display: flex; align-items: center; justify-content: flex-end;">
            <ul style="color: white; min-width: 180px; margin: 2rem;">
                <li><strong>Localnumber:</strong> {{ book.localnumber }}</li>
                {% if book.booklocation %}
                <li><strong>Location:</strong> {{ book.booklocation }}</li>
                {% endif %}
                {% if book.call1 %}
                <li><strong>Call1:</strong> {{ book.call1 }}</li>
                {% endif %}
                {% if book.call2 %}
                <li><strong>Call2:</strong> {{ book.call2 }}</li>
                {% endif %}
                {% if book.publisher %}
                <li><strong>Publisher:</strong> {{ book.publisher }}</li>
                {% endif %}
                {% if book.published and (book.published|regex_search('^\\d{4}(-\\d{2}){0,2}$')) %}
                <li><strong>Published:</strong> {{ book.published }}</li>
                {% endif %}
                {% if book.isbn %}
                <li><strong>ISBN:</strong> {{ book.isbn }}</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<div class="columns is-gapless" style="margin-top: 0.5rem;">
    <div class="column is-10 section py-3 px-5 ml-3" style="color: white; min-width: 250px;">
        {% if checkouts %}
        <table class="table is-fullwidth section has-text-white is-rounded" style="border-radius: 1rem; overflow: hidden;">
            <tbody>
            {% for c in checkouts %}
                <tr>
                    <td colspan="3" style="padding:0; border:none; background:none;">
                        <div class="is-rounded checkout-row" style="border-radius:0.75rem; overflow:hidden; margin-bottom:0.5rem; display:flex;">
                            <div style="{% if not c['return_date'] %}flex:1.7{% else %}flex:2{% endif %}; background: linear-gradient(90deg, #14161a 0%, {{ c['checkout_date'] | checkout_status(c['return_date']) }} 100%); padding:0.5rem 1rem; {% if not c['return_date'] %}border-top-left-radius:0.75rem; border-bottom-left-radius:0.75rem;{% else %}border-top-left-radius:0.75rem; border-bottom-left-radius:0.75rem; border-top-right-radius:0.75rem; border-bottom-right-radius:0.75rem;{% endif %} display: flex; justify-content: space-between; align-items: center;">
                                <div style="text-align: left;">
                                    <a href="/student/{{ c['student_fax_id'] }}" class="has-text-white has-text-weight-semibold">{{ c['student_name'] }}</a>
                                </div>
                                <div style="text-align: right;" title="Checked out: {{ c['checkout_date'] | nice_date }}">
                                    {% if c['return_date'] %}
                                        <div title="Returned: {{ c['return_date'] | nice_date }}">Returned: {{ c['return_date'] | nice_date }}</div>
                                    {% else %}
                                        <div>{{ c['checkout_date'] | due_date }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% if not c['return_date'] %}
                            <form method="POST" action="/return_book" style="margin: 0; flex: 0.3;">
                                <input type="hidden" name="checkout_id" value="{{ c['checkout_id'] }}">
                                <input type="hidden" name="redirect_url" value="{{ request.url }}">
                                <button type="button" class="has-background-primary has-text-white has-text-weight-semibold return-book-btn" data-checkout-id="{{ c['checkout_id'] }}" data-student-name="{{ c['student_name'] }}" data-redirect-url="{{ request.url }}" style="width: 100%; height: 100%; background: transparent; border: none; padding: 0.5rem; border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer;" title="Return this book">
                                    <span class="icon"><i class="fas fa-check"></i></span>
                                    <span>Return</span>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No checkouts for this book.</p>
        {% endif %}
    </div>
    <div class="column section py-3 px-3" style="display:flex;align-items:center;justify-content:end; min-width: 80px;">
        <span class="icon is-large has-text-primary">
            <i class="fas fa-clock fa-3x"></i>
        </span>
    </div>
</div>

<!-- Edit Book Modal -->
<div class="modal" id="edit-book-modal">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 600px; max-width: 90vw;">
        <header class="modal-card-head">
            <p class="modal-card-title">Edit Book Information</p>
            <button class="delete" aria-label="close" id="close-edit-book-modal"></button>
        </header>
        <section class="modal-card-body">
            <form id="edit-book-form">
                <div class="columns is-multiline">
                    <div class="column is-full">
                        <div class="field">
                            <label class="label">Title</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="title" value="{{ book.title }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="column is-full">
                        <div class="field">
                            <label class="label">Subtitle</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="subtitle" value="{{ book.subtitle or '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="column is-full">
                        <div class="field">
                            <label class="label">Author</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="author" value="{{ book.author }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Local Number</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="localnumber" value="{{ book.localnumber }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Location</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="booklocation" value="{{ book.booklocation or '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Call 1</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="call1" value="{{ book.call1 or '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Call 2</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="call2" value="{{ book.call2 or '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Publisher</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="publisher" value="{{ book.publisher or '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Published</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="published" value="{{ book.published or '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="column is-full">
                        <div class="field">
                            <label class="label">ISBN</label>
                            <div class="control">
                                <input class="input is-primary" type="text" name="isbn" value="{{ book.isbn or '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="column is-full">
                        <div class="field">
                            <label class="label">Upload Book Cover</label>
                            <div class="control">
                                <input class="input is-primary" type="file" id="edit-cover-file-input" accept="image/*" capture="environment">
                            </div>
                            <p class="help">Accepted formats: JPG, PNG, GIF, WebP (max 5MB). On mobile, tap to open camera.</p>
                        </div>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-primary has-text-white" id="save-book-btn">Save Changes</button>
            <button class="button" id="cancel-edit-book-btn">Cancel</button>
        </footer>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit book modal functionality
    const editBookBtn = document.getElementById('edit-book-btn');
    const editBookModal = document.getElementById('edit-book-modal');
    const closeEditBookModal = document.getElementById('close-edit-book-modal');
    const cancelEditBookBtn = document.getElementById('cancel-edit-book-btn');
    const saveBookBtn = document.getElementById('save-book-btn');
    const editBookForm = document.getElementById('edit-book-form');
    
    editBookBtn.addEventListener('click', function() {
        editBookModal.classList.add('is-active');
    });
    
    function closeModal() {
        editBookModal.classList.remove('is-active');
    }
    
    closeEditBookModal.addEventListener('click', closeModal);
    cancelEditBookBtn.addEventListener('click', closeModal);
    editBookModal.querySelector('.modal-background').addEventListener('click', closeModal);
    
    saveBookBtn.addEventListener('click', async function() {
        const formData = new FormData(editBookForm);
        const coverFile = document.getElementById('edit-cover-file-input');
        
        // Show loading state
        saveBookBtn.disabled = true;
        saveBookBtn.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span><span>Saving...</span>';
        
        try {
            // First, upload cover if a file is selected
            if (coverFile.files.length > 0) {
                const coverFormData = new FormData();
                coverFormData.append('cover', coverFile.files[0]);
                
                const coverResponse = await fetch(`/api/book/{{ book.localnumber }}/cover/upload`, {
                    method: 'POST',
                    body: coverFormData
                });
                
                const coverData = await coverResponse.json();
                if (!coverData.success) {
                    alert('Error uploading cover: ' + coverData.error);
                    saveBookBtn.disabled = false;
                    saveBookBtn.innerHTML = 'Save Changes';
                    return;
                }
            }
            
            // Then save book info
            const data = Object.fromEntries(formData.entries());
            // Remove the cover file from the form data as it's handled separately
            delete data['edit-cover-file-input'];
            
            const response = await fetch('/update_book/{{ book.rowid }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + (result.error || 'Unknown error'));
                saveBookBtn.disabled = false;
                saveBookBtn.innerHTML = 'Save Changes';
            }
        } catch (error) {
            alert('Error: ' + error.message);
            saveBookBtn.disabled = false;
            saveBookBtn.innerHTML = 'Save Changes';
        }
    });
    
    // Handle return book buttons
    document.querySelectorAll('.return-book-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const checkoutId = this.dataset.checkoutId;
            const bookTitle = this.dataset.bookTitle;
            const redirectUrl = this.dataset.redirectUrl;
            
            showConfirmation('Return Book', `Are you sure you want to return "${bookTitle}"?`, () => {
                // Create and submit form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/return_book';
                
                const checkoutInput = document.createElement('input');
                checkoutInput.type = 'hidden';
                checkoutInput.name = 'checkout_id';
                checkoutInput.value = checkoutId;
                form.appendChild(checkoutInput);
                
                const redirectInput = document.createElement('input');
                redirectInput.type = 'hidden';
                redirectInput.name = 'redirect_url';
                redirectInput.value = redirectUrl;
                form.appendChild(redirectInput);
                
                document.body.appendChild(form);
                form.submit();
            });
        });
    });
});
</script>

{% endblock %}