{% extends "base.html" %}

{% block head %}
    <title>Settings - Library Management</title>
{% endblock %}

{% block body %}
<div class="container">
    <div class="columns is-multiline is-vcentered is-mobile m-1">
        <div class="column">
            <div class="box has-background-primary is-flex is-align-items-center is-justify-content-space-between mb-3">
                <h1 class="title has-text-white mb-0">Settings</h1>
                <div class="icon has-text-white is-flex is-align-items-center">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
            <h2 class="subtitle has-text-white">Manage your library data</h2>
        </div>
    </div>
    
    <div class="settings-grid columns is-multiline is-mobile m-1">
        <!-- Primary (Green) Buttons -->
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-primary p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button" id="import-books-btn" type="button">
                            <span class="icon">
                                <i class="fas fa-file-import"></i>
                            </span>
                        </button>
                        <input type="file" id="books-file-input" accept=".csv" style="display: none;">
                    </div>
                    <div class="column">
                        <strong class="has-text-white is-vcentered">IMPORT BOOK LIST</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-primary p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button" id="export-books-btn" type="button">
                            <span class="icon">
                                <i class="fas fa-file-export"></i>
                            </span>
                        </button>
                    </div>
                    <div class="column">
                        <strong class="has-text-white is-vcentered">EXPORT BOOK LIST</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-primary p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button" id="load-backup-btn" type="button">
                            <span class="icon">
                                <i class="fas fa-upload"></i>
                            </span>
                        </button>
                    </div>
                    <div class="column">
                        <strong class="has-text-white is-vcentered">LOAD BACKUP</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-primary p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button" id="manage-classes-btn" type="button" title="Manage Classes">
                            <span class="icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </span>
                        </button>
                    </div>
                    <div class="column">
                        <strong class="has-text-white is-vcentered">MANAGE CLASSES</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Warning (Yellow) Buttons -->
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-warning p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button is-warning" id="remove-books-btn" type="button">
                            <span class="icon">
                                <i class="fas fa-trash"></i>
                            </span>
                        </button>
                    </div>
                    <div class="column">
                        <strong class="has-text-dark is-vcentered">REMOVE BOOKS</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-warning p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button is-warning" id="force-backup-btn" type="button">
                            <span class="icon">
                                <i class="fas fa-database"></i>
                            </span>
                        </button>
                    </div>
                    <div class="column">
                        <strong class="has-text-dark is-vcentered">FORCE BACKUP</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-warning p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button is-warning" id="clear-checkouts-btn" type="button" title="Clear all checkout records">
                            <span class="icon">
                                <i class="fas fa-trash-alt"></i>
                            </span>
                        </button>
                    </div>
                    <div class="column">
                        <strong class="has-text-dark is-vcentered">CLEAR CHECKOUTS</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Link (Blue) Buttons -->
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-link p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button" id="export-outstanding-btn" type="button" title="this is blue because dice wanted it to be blue">
                            <span class="icon">
                                <i class="fas fa-file-export"></i>
                            </span>
                        </button>
                    </div>
                    <div class="column">
                        <strong class="has-text-white is-vcentered">EXPORT OUTSTANDING</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Danger (Red) Buttons -->
        <div class="column is-half-tablet is-full-mobile">
            <div class="settings-item box has-background-danger p-2">
                <div class="columns is-vcentered is-mobile">
                    <div class="column is-narrow">
                        <button class="button" id="import-students-btn" type="button" title="Warning: replaces all current student data">
                            <span class="icon">
                                <i class="fas fa-users"></i>
                            </span>
                        </button>
                        <input type="file" id="students-file-input" accept=".csv" style="display: none;">
                    </div>
                    <div class="column">
                        <strong class="has-text-white is-vcentered">IMPORT STUDENTS</strong>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>



<!-- Manage Classes Modal -->
<div class="modal" id="manage-classes-modal">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 800px; max-width: 95vw;">
        <header class="modal-card-head">
            <p class="modal-card-title">Manage Classes</p>
            <button class="delete" aria-label="close" id="close-classes-modal-btn"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <h4 class="subtitle is-5">Current Classes</h4>
                <div id="classes-list" style="max-height: 400px; overflow-y: auto;">
                    {% for class in classes %}
                    <div class="box mb-3 has-background-primary">
                        <div class="is-flex is-justify-content-space-between is-align-items-center">
                            <div style="flex: 1; min-width: 0; overflow: hidden; margin-right: 15px;">
                                <h5 class="title is-6" style="line-height: 1.3; margin-bottom: 8px; font-size: 0.9rem;">{{ class.name }}</h5>
                                {% if class.teacher_name %}
                                <p class="subtitle is-7 has-text-white" style="margin-bottom: 0; margin-top: 2px; line-height: 1.2; font-size: 0.75rem;">Teacher: {{ class.teacher_name }}</p>
                                {% endif %}
                            </div>
                            <div style="flex-shrink: 0;">
                                <button class="button is-small is-warning" onclick="openManageClassModal({{ class.id }})" title="Manage Class" style="border-radius: 8px;">
                                    <span class="icon is-small">
                                        <i class="fas fa-cog"></i>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <button class="box mb-3 button is-white" id="add-class-btn" title="Add New Class" style="border: 2px dashed var(--bulma-primary); width: 100%; min-height: 60px; display: flex; justify-content: center; align-items: center; background: transparent;">
                        <span class="icon is-small has-text-primary">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span class="has-text-primary ml-2">Add New Class</span>
                    </button>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button" id="cancel-classes-btn">Close</button>
        </footer>
    </div>
</div>

<!-- Add Class Modal -->
<div class="modal" id="add-class-modal">
    <div class="modal-background" id="add-class-modal-bg"></div>
    <div class="modal-card" style="width: 500px; max-width: 90vw;">
        <header class="modal-card-head">
            <p class="modal-card-title">Add New Class</p>
            <button class="delete" aria-label="close" id="close-add-class-modal-btn"></button>
        </header>
        <section class="modal-card-body">
            <form id="add-class-form">
                <div class="field">
                    <label class="label">Class Name</label>
                    <div class="control">
                        <input class="input is-primary" type="text" name="class_name" placeholder="Enter class name..." required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Teacher Name</label>
                    <div class="control">
                        <input class="input is-primary" type="text" name="teacher_name" placeholder="Enter teacher name...">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Add Students</label>
                    <div class="control">
                        <input class="input is-primary" type="text" id="class-student-search" placeholder="Search for students to add..." autocomplete="off">
                        <div id="class-student-results" class="box" style="display:none; max-height: 150px; overflow-y: auto; margin-top: 5px;"></div>
                    </div>
                </div>
                <!-- Floating student chips -->
                <div id="selected-students" class="columns is-multiline is-mobile" style="margin-top: 15px;">
                    <div class="column is-full has-text-centered has-text-grey" id="no-students-message">No students selected</div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-primary has-text-white" id="save-class-btn">Save Class</button>
            <button class="button" id="cancel-add-class-btn">Cancel</button>
        </footer>
    </div>
</div>

<!-- Manage Class Modal -->
<div class="modal" id="manage-class-modal">
    <div class="modal-background" id="manage-class-modal-bg"></div>
    <div class="modal-card" style="width: 500px; max-width: 90vw;">
        <header class="modal-card-head">
            <p class="modal-card-title">Manage Class</p>
            <button class="delete" aria-label="close" id="close-manage-class-modal-btn"></button>
        </header>
        <section class="modal-card-body">
            <form id="manage-class-form">
                <input type="hidden" id="manage-class-id" name="class_id">
                <div class="field">
                    <label class="label">Class Name</label>
                    <div class="control">
                        <input class="input is-primary" type="text" id="manage-class-name" name="class_name" placeholder="Enter class name..." required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Teacher Name</label>
                    <div class="control">
                        <input class="input is-primary" type="text" id="manage-teacher-name" name="teacher_name" placeholder="Enter teacher name...">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Add Students</label>
                    <div class="control">
                        <input class="input is-primary" type="text" id="manage-student-search" placeholder="Search for students to add..." autocomplete="off">
                        <div id="manage-student-results" class="box" style="display:none; max-height: 150px; overflow-y: auto; margin-top: 5px;"></div>
                    </div>
                </div>
                <!-- Floating student chips -->
                <div id="manage-selected-students" class="columns is-multiline is-mobile" style="margin-top: 15px;">
                    <div class="column is-full has-text-centered has-text-grey" id="manage-no-students-message">Loading...</div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-primary has-text-white" id="update-class-btn">Update Class</button>
            <button class="button is-danger has-text-white" id="delete-class-btn">Delete Class</button>
            <button class="button" id="cancel-manage-class-btn">Cancel</button>
        </footer>
    </div>
</div>

<!-- Load Backup Modal -->
<div class="modal" id="load-backup-modal">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 700px; max-width: 95vw;">
        <header class="modal-card-head">
            <p class="modal-card-title">Select Backup to Restore</p>
            <button class="delete" aria-label="close" id="close-load-backup-modal-btn"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <div class="notification has-background-warning has-text-white mb-4">
                    <strong>Warning:</strong> Restoring a backup will replace your current database. This action cannot be undone. A backup of your current data will be created before restoration.
                </div>
                
                <h4 class="subtitle is-5 has-text-white">Available Backups</h4>
                <div id="backup-loading" class="has-text-centered" style="display: none;">
                    <span class="icon is-large has-text-primary">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                    </span>
                    <p class="has-text-white mt-2">Loading backups...</p>
                </div>
                
                <div id="backup-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Backups will be populated here -->
                </div>
                
                <div id="no-backups-message" class="has-text-centered has-text-grey" style="display: none;">
                    <span class="icon is-large">
                        <i class="fas fa-folder-open fa-2x"></i>
                    </span>
                    <p class="mt-2">No backups found</p>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-primary has-text-white" id="restore-selected-backup-btn" disabled>Restore Selected</button>
            <button class="button" id="cancel-load-backup-btn">Cancel</button>
        </footer>
    </div>
</div>

<!-- Remove Books Modal -->
<div class="modal" id="remove-books-modal">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 500px; max-width: 90vw;">
        <header class="modal-card-head">
            <p class="modal-card-title">Remove Books</p>
            <button class="delete" aria-label="close" id="close-remove-books-modal-btn"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Search for books</label>
                <input class="input is-danger" type="text" id="remove-book-search" placeholder="Search for book..." autocomplete="off">
            </div>
            <div class="field">
                <label class="label">Selected Books</label>
                <div id="remove-book-chips" class="chips-container"></div>
            </div>
            <div class="field">
                <div id="remove-book-results"></div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-danger" id="confirm-remove-books-btn" type="button">Remove Selected</button>
            <button class="button" id="cancel-remove-books-btn" style="margin-left: 1rem;">Cancel</button>
        </footer>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking for elements...');
    
    const manageClassesBtn = document.getElementById('manage-classes-btn');
    const manageClassesModal = document.getElementById('manage-classes-modal');
    console.log('Button found:', manageClassesBtn);
    console.log('Modal found:', manageClassesModal);
    
    if (!manageClassesBtn) {
        console.error('Manage classes button not found!');
        return;
    }
    
    if (!manageClassesModal) {
        console.error('Manage classes modal not found!');
        return;
    }
    // Import books functionality
    document.getElementById('import-books-btn').addEventListener('click', function() {
        document.getElementById('books-file-input').click();
    });

    document.getElementById('books-file-input').addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload_books', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Import completed, could optionally show success in UI
            })
            .catch(error => {
                console.error('Import error:', error);
            });
        }
    });

    // Export books functionality
    document.getElementById('export-books-btn').addEventListener('click', function() {
        window.location.href = '/export_books';
    });

    // Export outstanding students functionality
    document.getElementById('export-outstanding-btn').addEventListener('click', function() {
        window.location.href = '/export_outstanding_students';
    });

    // Import students functionality
    document.getElementById('import-students-btn').addEventListener('click', function() {
        document.getElementById('students-file-input').click();
    });

    document.getElementById('students-file-input').addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload_students', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Import completed, could optionally show success in UI
            })
            .catch(error => {
                console.error('Import error:', error);
            });
        }
    });

    // Load backup functionality
    document.getElementById('load-backup-btn').addEventListener('click', function() {
        document.getElementById('load-backup-modal').classList.add('is-active');
        loadAvailableBackups();
    });

    // Close load backup modal
    document.getElementById('close-load-backup-modal-btn').addEventListener('click', function() {
        document.getElementById('load-backup-modal').classList.remove('is-active');
    });

    document.getElementById('cancel-load-backup-btn').addEventListener('click', function() {
        document.getElementById('load-backup-modal').classList.remove('is-active');
    });

    // Close modal when clicking background
    document.querySelector('#load-backup-modal .modal-background').addEventListener('click', function() {
        document.getElementById('load-backup-modal').classList.remove('is-active');
    });

    let selectedBackupFile = null;

    function loadAvailableBackups() {
        const loadingDiv = document.getElementById('backup-loading');
        const backupList = document.getElementById('backup-list');
        const noBackupsMessage = document.getElementById('no-backups-message');
        const restoreBtn = document.getElementById('restore-selected-backup-btn');

        // Show loading
        loadingDiv.style.display = 'block';
        backupList.style.display = 'none';
        noBackupsMessage.style.display = 'none';
        restoreBtn.disabled = true;
        selectedBackupFile = null;

        fetch('/list_backups')
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                
                if (data.success && data.backups && data.backups.length > 0) {
                    displayBackups(data.backups);
                    backupList.style.display = 'block';
                } else {
                    noBackupsMessage.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading backups:', error);
                loadingDiv.style.display = 'none';
                noBackupsMessage.style.display = 'block';
            });
    }

    function displayBackups(backups) {
        const backupList = document.getElementById('backup-list');
        const restoreBtn = document.getElementById('restore-selected-backup-btn');

        const backupHTML = backups.map(backup => {
            const date = new Date(backup.timestamp);
            const formattedDate = date.toLocaleString();
            const sizeKB = Math.round(backup.size / 1024);
            
            const typeColors = {
                'daily': 'is-info',
                'frequent': 'is-success', 
                'events': 'is-warning',
                'manual': 'is-primary'
            };
            
            const typeColor = typeColors[backup.backup_type] || 'is-primary';
            const description = backup.event_description ? ` - ${backup.event_description}` : '';
            
            return `
                <div class="backup-item box has-background-dark mb-3" data-file-path="${backup.file_path}" style="cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s;">
                    <div class="is-flex is-justify-content-space-between is-align-items-center">
                        <div style="flex: 1;">
                            <div class="is-flex is-align-items-center mb-2">
                                <span class="tag ${typeColor} is-small mr-2">${backup.backup_type.toUpperCase()}</span>
                                <strong class="has-text-white">${formattedDate}</strong>
                            </div>
                            <p class="has-text-grey is-size-7 mb-1">${sizeKB} KB${description}</p>
                            ${backup.compression_ratio ? `<p class="has-text-grey is-size-7">Compression: ${Math.round((1 - backup.compression_ratio) * 100)}%</p>` : ''}
                        </div>
                        <div class="backup-selected-indicator" style="display: none;">
                            <span class="icon has-text-success">
                                <i class="fas fa-check-circle fa-lg"></i>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        backupList.innerHTML = backupHTML;

        // Add click handlers for backup selection
        document.querySelectorAll('.backup-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove selection from all items
                document.querySelectorAll('.backup-item').forEach(otherItem => {
                    otherItem.style.borderColor = 'transparent';
                    otherItem.querySelector('.backup-selected-indicator').style.display = 'none';
                });
                
                // Select this item
                this.style.borderColor = 'var(--bulma-success)';
                this.querySelector('.backup-selected-indicator').style.display = 'block';
                
                selectedBackupFile = this.dataset.filePath;
                restoreBtn.disabled = false;
            });
        });
    }

    // Restore selected backup
    document.getElementById('restore-selected-backup-btn').addEventListener('click', function() {
        if (!selectedBackupFile) return;

        const restoreBtn = this;
        const originalText = restoreBtn.innerHTML;

        // Show loading state
        restoreBtn.disabled = true;
        restoreBtn.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span><span>Restoring...</span>';

        fetch('/restore_backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                backup_file: selectedBackupFile
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Backup restored successfully');
                document.getElementById('load-backup-modal').classList.remove('is-active');
                // Show success message and reload page
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                console.error('Restore failed:', data.message);
                restoreBtn.innerHTML = originalText;
                restoreBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Restore error:', error);
            restoreBtn.innerHTML = originalText;
            restoreBtn.disabled = false;
        });
    });

    // Force backup functionality
    document.getElementById('force-backup-btn').addEventListener('click', function() {
        console.log('Force backup button clicked');
        
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span>';
        
        fetch('/force_backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Backup created successfully');
                // Optional: Show a brief success indicator
                this.innerHTML = '<span class="icon"><i class="fas fa-check"></i></span>';
                setTimeout(() => {
                    this.innerHTML = '<span class="icon"><i class="fas fa-database"></i></span>';
                    this.disabled = false;
                }, 2000);
            } else {
                console.error('Backup failed:', data.error);
                this.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span>';
                setTimeout(() => {
                    this.innerHTML = '<span class="icon"><i class="fas fa-database"></i></span>';
                    this.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Backup error:', error);
            this.innerHTML = '<span class="icon"><i class="fas fa-exclamation-triangle"></i></span>';
            setTimeout(() => {
                this.innerHTML = '<span class="icon"><i class="fas fa-database"></i></span>';
                this.disabled = false;
            }, 2000);
        });
    });

    // Clear checkouts functionality
    document.getElementById('clear-checkouts-btn').addEventListener('click', function() {
        showConfirmation(
            'Clear All Checkouts',
            'Are you sure you want to delete all checkout records? This action cannot be undone. A backup will be created automatically.',
            function() {
                // Show loading state
                const btn = document.getElementById('clear-checkouts-btn');
                const originalIcon = btn.querySelector('i').className;
                btn.querySelector('i').className = 'fas fa-spinner fa-spin';
                btn.disabled = true;

                fetch('/clear_checkouts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success notification
                        const notification = document.createElement('div');
                        notification.className = 'notification is-success';
                        notification.innerHTML = `
                            <button class="delete"></button>
                            <strong>Success!</strong> ${data.message}
                        `;
                        document.body.appendChild(notification);
                        
                        // Auto-remove notification
                        setTimeout(() => {
                            notification.remove();
                        }, 5000);
                        
                        // Add delete button functionality
                        notification.querySelector('.delete').addEventListener('click', () => {
                            notification.remove();
                        });
                    } else {
                        throw new Error(data.error || 'Failed to clear checkouts');
                    }
                })
                .catch(error => {
                    console.error('Error clearing checkouts:', error);
                    // Show error notification
                    const notification = document.createElement('div');
                    notification.className = 'notification is-danger';
                    notification.innerHTML = `
                        <button class="delete"></button>
                        <strong>Error!</strong> Failed to clear checkouts: ${error.message}
                    `;
                    document.body.appendChild(notification);
                    
                    // Auto-remove notification
                    setTimeout(() => {
                        notification.remove();
                    }, 5000);
                    
                    // Add delete button functionality
                    notification.querySelector('.delete').addEventListener('click', () => {
                        notification.remove();
                    });
                })
                .finally(() => {
                    // Restore button state
                    btn.querySelector('i').className = originalIcon;
                    btn.disabled = false;
                });
            }
        );
    });

    // Manage classes functionality
    document.getElementById('manage-classes-btn').addEventListener('click', function(e) {
        console.log('Manage classes button clicked');
        e.preventDefault();
        e.stopPropagation();
        const modal = document.getElementById('manage-classes-modal');
        console.log('Modal element:', modal);
        if (modal) {
            modal.classList.add('is-active');
            console.log('Modal should now be active, classes:', modal.classList);
        } else {
            console.error('Modal element not found!');
        }
    });

    // Show/hide floating add button based on scroll position in classes list
    const classesList = document.getElementById('classes-list');
    const addClassBtn = document.getElementById('add-class-btn');
    
    classesList.addEventListener('scroll', function() {
        const scrollTop = classesList.scrollTop;
        const scrollHeight = classesList.scrollHeight;
        const clientHeight = classesList.clientHeight;
        
        // Show button when scrolled near bottom (within 100px)
        if (scrollTop + clientHeight >= scrollHeight - 100) {
            addClassBtn.style.opacity = '1';
        } else {
            addClassBtn.style.opacity = '0';
        }
    });

    // Close manage classes modal
    document.getElementById('close-classes-modal-btn').addEventListener('click', function() {
        document.getElementById('manage-classes-modal').classList.remove('is-active');
    });

    document.getElementById('cancel-classes-btn').addEventListener('click', function() {
        document.getElementById('manage-classes-modal').classList.remove('is-active');
    });

    // Close modal when clicking background
    document.querySelector('#manage-classes-modal .modal-background').addEventListener('click', function() {
        document.getElementById('manage-classes-modal').classList.remove('is-active');
    });

    // Add class modal functionality
    document.getElementById('add-class-btn').addEventListener('click', function() {
        document.getElementById('add-class-modal').classList.add('is-active');
    });

    // Close add class modal
    document.getElementById('close-add-class-modal-btn').addEventListener('click', function() {
        document.getElementById('add-class-modal').classList.remove('is-active');
    });

    document.getElementById('cancel-add-class-btn').addEventListener('click', function() {
        document.getElementById('add-class-modal').classList.remove('is-active');
    });

    // DON'T close on background click for add class modal (preventing accidental closes)
    // document.getElementById('add-class-modal-bg').addEventListener('click', function() {
    //     document.getElementById('add-class-modal').classList.remove('is-active');
    // });

    // Student search for add class modal
    const classStudentSearch = document.getElementById('class-student-search');
    const classStudentResults = document.getElementById('class-student-results');
    const selectedStudentsContainer = document.getElementById('selected-students');
    const noStudentsMessage = document.getElementById('no-students-message');
    let selectedStudents = [];

    if (classStudentSearch) {
        classStudentSearch.addEventListener('input', function() {
            const query = classStudentSearch.value.trim();
            if (query.length < 2) {
                classStudentResults.style.display = 'none';
                return;
            }
            fetch(`/search_students?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        classStudentResults.innerHTML = data.map(s => 
                            `<div class="student-option" data-id="${s.id}" data-name="${s.name}" data-fax="${s.fax_id}" data-class-id="${s.class_id}" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #6a9a75; background: #2b2d31; color: white;">${s.name} (${s.fax_id})</div>`
                        ).join('');
                        classStudentResults.style.display = 'block';
                    } else {
                        classStudentResults.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Student search error:', err);
                });
        });
        
        classStudentResults.addEventListener('click', function(e) {
            if (e.target.classList.contains('student-option')) {
                const studentId = e.target.dataset.id;
                const studentName = e.target.dataset.name;
                const studentFax = e.target.dataset.fax;
                const studentClassId = e.target.dataset.classId;
                
                // Check if student is already selected
                if (!selectedStudents.find(s => s.id === studentId)) {
                    selectedStudents.push({
                        id: studentId,
                        name: studentName,
                        fax_id: studentFax,
                        class_id: studentClassId
                    });
                    updateSelectedStudentsDisplay();
                }
                
                classStudentSearch.value = '';
                classStudentResults.style.display = 'none';
            }
        });
    }

    function updateSelectedStudentsDisplay() {
        if (selectedStudents.length === 0) {
            selectedStudentsContainer.innerHTML = '<div class="column is-full has-text-centered has-text-grey" id="no-students-message">No students selected</div>';
            return;
        }

        const studentsHTML = selectedStudents.map(student => {
            // A student has a class if class_id is not the string 'null'
            const hasClass = student.class_id !== 'null';
            const chipClass = hasClass ? 'danger' : 'primary';
            const title = hasClass ? 'Student already assigned to a class' : 'Available student';
            
            return `
                <div class="column is-narrow">
                    <div class="box has-background-${chipClass} p-1" style="display: inline-flex; align-items: center; width: fit-content; border-radius: 8px; gap: 8px;" title="${title}">
                        <span class="has-text-white is-size-7" style="font-weight: 500;">${student.name}</span>
                        <button class="delete is-small is-warning" onclick="removeStudent('${student.id}')" title="Remove student"></button>
                    </div>
                </div>
            `;
        }).join('');
        
        selectedStudentsContainer.innerHTML = studentsHTML;
    }

    // Global function to remove student (accessible from onclick)
    window.removeStudent = function(studentId) {
        selectedStudents = selectedStudents.filter(s => s.id !== studentId);
        updateSelectedStudentsDisplay();
    };

    // Clear selected students when modal opens
    document.getElementById('add-class-btn').addEventListener('click', function() {
        selectedStudents = [];
        updateSelectedStudentsDisplay();
        document.getElementById('add-class-modal').classList.add('is-active');
    });

    // Save class functionality
    document.getElementById('save-class-btn').addEventListener('click', function() {
        const form = document.getElementById('add-class-form');
        const formData = new FormData(form);
        const className = formData.get('class_name').trim();
        const teacherName = formData.get('teacher_name').trim();
        
        if (!className) {
            return;
        }
        
        const studentIds = selectedStudents.map(s => parseInt(s.id));
        
        fetch('/add_class', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                class_name: className,
                teacher_name: teacherName,
                student_ids: studentIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('add-class-modal').classList.remove('is-active');
                // Refresh the classes list
                location.reload();
            } else {
                console.error('Error adding class:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error.message);
        });
    });

    // Manage Class Modal Variables
    const manageStudentSearch = document.getElementById('manage-student-search');
    const manageStudentResults = document.getElementById('manage-student-results');
    const manageSelectedStudentsContainer = document.getElementById('manage-selected-students');
    let manageSelectedStudents = [];
    let currentClassId = null;

    // Global function to open manage class modal
    window.openManageClassModal = function(classId) {
        currentClassId = classId;
        document.getElementById('manage-class-id').value = classId;
        
        // Load class data
        fetch(`/get_class/${classId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate form fields
                    document.getElementById('manage-class-name').value = data.class.name;
                    document.getElementById('manage-teacher-name').value = data.class.teacher_name || '';
                    
                    // Populate selected students
                    manageSelectedStudents = data.students.map(student => ({
                        id: student.id.toString(),
                        name: student.name,
                        fax_id: student.fax_id,
                        class_id: classId.toString() // They're already in this class
                    }));
                    updateManageSelectedStudentsDisplay();
                    
                    // Show modal
                    document.getElementById('manage-class-modal').classList.add('is-active');
                } else {
                    console.error('Error loading class:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error.message);
            });
    };

    // Manage class student search functionality
    if (manageStudentSearch) {
        manageStudentSearch.addEventListener('input', function() {
            const query = manageStudentSearch.value.trim();
            if (query.length < 2) {
                manageStudentResults.style.display = 'none';
                return;
            }
            fetch(`/search_students?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        manageStudentResults.innerHTML = data.map(s => 
                            `<div class="student-option" data-id="${s.id}" data-name="${s.name}" data-fax="${s.fax_id}" data-class-id="${s.class_id}" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #6a9a75; background: #2b2d31; color: white;">${s.name}</div>`
                        ).join('');
                        manageStudentResults.style.display = 'block';
                    } else {
                        manageStudentResults.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Student search error:', err);
                });
        });
        
        manageStudentResults.addEventListener('click', function(e) {
            if (e.target.classList.contains('student-option')) {
                const studentId = e.target.dataset.id;
                const studentName = e.target.dataset.name;
                const studentFax = e.target.dataset.fax;
                const studentClassId = e.target.dataset.classId;
                
                // Check if student is already selected
                if (!manageSelectedStudents.find(s => s.id === studentId)) {
                    manageSelectedStudents.push({
                        id: studentId,
                        name: studentName,
                        fax_id: studentFax,
                        class_id: studentClassId
                    });
                    updateManageSelectedStudentsDisplay();
                }
                
                manageStudentSearch.value = '';
                manageStudentResults.style.display = 'none';
            }
        });
    }

    function updateManageSelectedStudentsDisplay() {
        if (manageSelectedStudents.length === 0) {
            manageSelectedStudentsContainer.innerHTML = '<div class="column is-full has-text-centered has-text-grey" id="manage-no-students-message">No students selected</div>';
            return;
        }

        const studentsHTML = manageSelectedStudents.map(student => {
            // In manage mode, students in the current class being managed should show as primary (green)
            // Students in OTHER classes should show as danger (red)
            const isInCurrentClass = student.class_id === currentClassId.toString();
            const isInOtherClass = student.class_id !== 'null' && student.class_id !== null && !isInCurrentClass;
            const chipClass = isInOtherClass ? 'danger' : 'primary';
            const title = isInOtherClass ? 'Student already assigned to another class' : 
                         isInCurrentClass ? 'Student currently in this class' : 'Available student';
            
            return `
                <div class="column is-narrow">
                    <div class="box has-background-${chipClass} p-1" style="display: inline-flex; align-items: center; width: fit-content; border-radius: 8px; gap: 8px;" title="${title}">
                        <span class="has-text-white is-size-7" style="font-weight: 500;">${student.name}</span>
                        <button class="delete is-small is-warning" onclick="removeManageStudent('${student.id}')" title="Remove student"></button>
                    </div>
                </div>
            `;
        }).join('');
        
        manageSelectedStudentsContainer.innerHTML = studentsHTML;
    }

    // Global function to remove student from manage modal
    window.removeManageStudent = function(studentId) {
        manageSelectedStudents = manageSelectedStudents.filter(s => s.id !== studentId);
        updateManageSelectedStudentsDisplay();
    };

    // Close manage class modal
    document.getElementById('close-manage-class-modal-btn').addEventListener('click', function() {
        document.getElementById('manage-class-modal').classList.remove('is-active');
    });

    document.getElementById('cancel-manage-class-btn').addEventListener('click', function() {
        document.getElementById('manage-class-modal').classList.remove('is-active');
    });

    // Delete class functionality
    document.getElementById('delete-class-btn').addEventListener('click', function() {
        showConfirmation('Delete Class', 'Are you sure you want to delete this class? This action cannot be undone.', () => {
            fetch(`/delete_class/${currentClassId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('manage-class-modal').classList.remove('is-active');
                    // Refresh the classes list
                    location.reload();
                } else {
                    console.error('Error deleting class:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error.message);
            });
        });
    });

    // Update class functionality
    document.getElementById('update-class-btn').addEventListener('click', function() {
        const form = document.getElementById('manage-class-form');
        const formData = new FormData(form);
        const className = formData.get('class_name').trim();
        const teacherName = formData.get('teacher_name').trim();
        
        if (!className) {
            return;
        }
        
        const studentIds = manageSelectedStudents.map(s => parseInt(s.id));
        
        fetch(`/update_class/${currentClassId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                class_name: className,
                teacher_name: teacherName,
                student_ids: studentIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('manage-class-modal').classList.remove('is-active');
                // Refresh the classes list
                location.reload();
            } else {
                console.error('Error updating class:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error.message);
        });
    });



    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const removeBooksBtn = document.getElementById('remove-books-btn');
    const removeBooksModal = document.getElementById('remove-books-modal');
    const closeRemoveBooksModalBtn = document.getElementById('close-remove-books-modal-btn');
    const cancelRemoveBooksBtn = document.getElementById('cancel-remove-books-btn');
    const confirmRemoveBooksBtn = document.getElementById('confirm-remove-books-btn');
    const removeBookSearch = document.getElementById('remove-book-search');
    const removeBookResults = document.getElementById('remove-book-results');
    const removeBookChips = document.getElementById('remove-book-chips');
    let selectedBooks = [];

    removeBooksBtn.addEventListener('click', function() {
        removeBooksModal.classList.add('is-active');
        removeBookSearch.value = '';
        removeBookResults.innerHTML = '';
        renderChips();
    });

    function closeModal() {
        removeBooksModal.classList.remove('is-active');
        removeBookSearch.value = '';
        removeBookResults.innerHTML = '';
        selectedBooks = [];
        renderChips();
    }
    closeRemoveBooksModalBtn.addEventListener('click', closeModal);
    cancelRemoveBooksBtn.addEventListener('click', closeModal);
    removeBooksModal.querySelector('.modal-background').addEventListener('click', closeModal);

    removeBookSearch.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            removeBookResults.innerHTML = '';
            return;
        }
        fetch(`/search_books?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.books && data.books.length > 0) {
                    const availableBooks = data.books.filter(book => !selectedBooks.some(b => String(b.id) === String(book.id)));
                    if (availableBooks.length > 0) {
                        removeBookResults.innerHTML = availableBooks.map(book =>
                            `<div class="box is-flex is-align-items-center is-justify-content-space-between">
                                <span>${book.title} <small>(${book.author})</small></span>
                                <button class="button is-small is-danger add-chip-btn" data-book-id="${book.id}" data-book-title="${book.title}">Add</button>
                            </div>`
                        ).join('');
                        document.querySelectorAll('.add-chip-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const bookId = this.dataset.bookId;
                                const bookTitle = this.dataset.bookTitle;
                                if (!selectedBooks.some(b => String(b.id) === String(bookId))) {
                                    selectedBooks.push({id: bookId, title: bookTitle});
                                    renderChips();

                                    removeBookSearch.dispatchEvent(new Event('input'));
                                }
                            });
                        });
                    } else {
                        removeBookResults.innerHTML = '<p>All books matching your search are already selected.</p>';
                    }
                } else {
                    removeBookResults.innerHTML = '<p>No books found.</p>';
                }
            });
    });

    function renderChips() {
        removeBookChips.innerHTML = selectedBooks.map(book =>
            `<div class="column is-narrow">
                <div class="box has-background-danger p-1" style="display: inline-flex; align-items: center; width: fit-content; border-radius: 8px; gap: 8px;">
                    <span class="has-text-white is-size-7" style="font-weight: 500;">${book.title}</span>
                    <button class="delete is-small is-warning remove-chip-btn" data-book-id="${book.id}"></button>
                </div>
            </div>`
        ).join('');
        document.querySelectorAll('.remove-chip-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const bookId = this.dataset.bookId;
                selectedBooks = selectedBooks.filter(b => String(b.id) !== String(bookId));
                renderChips();
                if (removeBookSearch.value.trim().length >= 2) {
                    removeBookSearch.dispatchEvent(new Event('input'));
                }
            });
        });
    }

    confirmRemoveBooksBtn.addEventListener('click', function() {
        if (selectedBooks.length === 0) {
            alert('Select at least one book to remove.');
            return;
        }
        
        const bookCount = selectedBooks.length;
        const bookWord = bookCount === 1 ? 'book' : 'books';
        showConfirmation(
            'Remove Books',
            `Are you sure you want to remove ${bookCount} ${bookWord}? This action cannot be undone. A backup will be created automatically.`,
            function() {
                // Show loading state
                confirmRemoveBooksBtn.disabled = true;
                confirmRemoveBooksBtn.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span><span>Removing...</span>';
                
                fetch('/remove_books', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({book_ids: selectedBooks.map(b => b.id)})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeModal();
                        location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                        confirmRemoveBooksBtn.disabled = false;
                        confirmRemoveBooksBtn.innerHTML = 'Remove Selected';
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                    confirmRemoveBooksBtn.disabled = false;
                    confirmRemoveBooksBtn.innerHTML = 'Remove Selected';
                });
            }
        );
    });
});
</script>
{% endblock %}